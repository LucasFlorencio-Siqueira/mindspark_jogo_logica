<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindSpark Quiz - Ultimate</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --correct: #27ae60;
            --wrong: #c0392b;
            --light: #ffffff;
            --vs-color: #8e44ad;
            --online-color: #e67e22; /* Cor Laranja para o modo Online */
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f6f7;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-top: 30px;
            box-sizing: border-box;
        }
        .logo {
            height: 120px;
            width: auto;
            margin-bottom: 1.5rem;
            object-fit: contain;
        }
        .container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            width: 95%;
            max-width: 600px;
            overflow: hidden;
            position: relative;
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }
        .header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            transition: background-color 0.5s;
        }
        .timer-bar { height: 6px; background-color: var(--accent); width: 100%; transition: width 1s linear; }
        .content { padding: 25px; text-align: center; flex-grow: 1; }
        .screen { display: none; animation: fadeIn 0.4s ease-in-out; }
        .active { display: block; }
        
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none;}
        input:focus { border-color: var(--accent); }
        
        button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: 0.2s; font-weight: bold; }
        
        .btn-main { background-color: var(--accent); color: white; }
        .btn-main:hover { background-color: #1f6391; }
        
        .btn-vs { background-color: var(--vs-color); color: white; }
        .btn-vs:hover { background-color: #732d91; }

        .btn-online { background-color: var(--online-color); color: white; }
        .btn-online:hover { background-color: #d35400; }

        /* Bot√£o Padr√£o */
.btn-option { 
    background-color: var(--light); 
    color: #333; 
    text-align: left; 
    margin-bottom: 10px; 
    font-weight: normal; 
    border-left: 5px solid transparent; 
    transition: transform 0.1s; /* Removi transition de background para a cor entrar na hora */
}

/* Hover (s√≥ funciona se N√ÉO tiver a classe correct ou wrong) */
.btn-option:hover:not(.correct):not(.wrong) { 
    background-color: #dce4e6; 
    transform: translateX(3px); 
}

/* ACERTO - Prioridade M√°xima */
.btn-option.correct { 
    background-color: var(--correct) !important; 
    color: white !important; 
    border-left-color: #1e8449 !important; 
    pointer-events: none; /* Impede novos cliques e remove o estado de hover */
}

/* ERRO - Prioridade M√°xima */
.btn-option.wrong { 
    background-color: var(--wrong) !important; 
    color: white !important; 
    border-left-color: #922b21 !important; 
    pointer-events: none; /* Impede novos cliques e remove o estado de hover */
}
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--accent); color: white; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        
        .vs-score-board { display: flex; justify-content: space-around; margin: 20px 0; font-size: 1.2em; padding: 15px; background: #f9f9f9; border-radius: 10px; }
        .winner-highlight { color: var(--correct); font-size: 1.6em; margin-top: 15px; font-weight: bold; }
        
        .room-code-display { font-size: 3em; letter-spacing: 5px; color: var(--online-color); font-weight: bold; margin: 10px 0; background: #fff3e0; padding: 10px; border-radius: 10px; border: 2px dashed var(--online-color); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<img class="logo" src="static\logo_mindspark.jpeg" alt="logo mindspark">
<div class="container">
    
    <div id="screen-menu" class="screen active content">
        <h1 style="color: var(--primary);">‚ö° MindSpark</h1>
        <p style="color: #666;">Teste sua L√≥gica e Filosofia</p>
        
        <button class="btn-main" onclick="window.goToRankedSetup()">üèÜ Rankeada Global</button>
        <button class="btn-vs" onclick="window.goTo1v1Setup()">‚öîÔ∏è 1 vs 1 Local</button>
        <button class="btn-online" onclick="window.goToOnlineSetup()">üåê 1 vs 1 Online</button>
    </div>

    <div id="screen-setup-ranked" class="screen content">
        <h2 style="color: var(--accent);">üèÜ Modo Rankeada</h2>
        <p>Valendo pontua√ß√£o no ranking global.</p>
        <label>Seu Nickname:</label>
        <input type="text" id="nick-ranked" placeholder="Ex: Aristoteles_Junior" maxlength="15">
        <button class="btn-main" onclick="window.startRanked()">Iniciar Desafio</button>
        <button style="background: #95a5a6; color:white" onclick="location.reload()">Voltar</button>
    </div>

    <div id="screen-setup-1v1" class="screen content">
        <h2 style="color: var(--vs-color);">‚öîÔ∏è Modo 1 vs 1 Local</h2>
        <p>Dividam o mesmo dispositivo.</p>
        <input type="text" id="nick-p1" placeholder="Nome Jogador 1" maxlength="10">
        <input type="text" id="nick-p2" placeholder="Nome Jogador 2" maxlength="10">
        <button class="btn-vs" onclick="window.start1v1()">Come√ßar Batalha</button>
        <button style="background: #95a5a6; color:white" onclick="location.reload()">Voltar</button>
    </div>

    <div id="screen-setup-online" class="screen content">
        <h2 style="color: var(--online-color);">üåê Modo Online</h2>
        <p>Jogue em tempo real em dispositivos diferentes.</p>
        
        <input type="text" id="nick-online" placeholder="Seu Nickname" maxlength="12">
        
        <div style="margin: 20px 0; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>Criar uma Sala</h3>
            <button class="btn-online" onclick="window.createRoom()">üè† Gerar C√≥digo de Sala</button>
        </div>
        
        <div style="margin: 20px 0; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>Ou Entrar em Sala</h3>
            <input type="number" id="room-code-input" placeholder="Digite o C√≥digo (Ex: 1234)">
            <button class="btn-main" onclick="window.joinRoom()">‚û°Ô∏è Conectar</button>
        </div>

        <button style="background: #95a5a6; color:white" onclick="location.reload()">Voltar</button>
    </div>

    <div id="screen-lobby" class="screen content">
        <h2>Aguardando Oponente...</h2>
        <p>Compartilhe este c√≥digo com seu amigo:</p>
        <div id="display-room-code" class="room-code-display">----</div>
        <div class="loader" style="display:block"></div>
        <p style="font-size: 0.9em; color: gray;">O jogo come√ßar√° automaticamente assim que ele entrar.</p>
        <button style="background: #e74c3c; color:white; margin-top: 30px;" onclick="location.reload()">Cancelar</button>
    </div>

    <div id="screen-intermission" class="screen content">
        <h2 style="color: var(--vs-color)">‚úã Pare!</h2>
        <h3>Fim da vez do Jogador 1</h3>
        <p>Passe o dispositivo para o <strong>Jogador 2</strong>.</p>
        <button class="btn-vs" onclick="window.resumeGame1v1()">Sou o Jogador 2, Estou Pronto!</button>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="header" id="quiz-header">
            <span id="player-turn-display">Jogador 1</span>
            <span id="q-progress">Q: 1/10</span>
            <span id="time-display">25s</span>
        </div>
        <div class="timer-bar" id="timer-bar"></div>
        <div class="content">
            <div id="question-text" style="font-size: 1.1em; font-weight: bold; margin-bottom: 20px; min-height: 60px;">...</div>
            <div id="options-container"></div>
            <div id="feedback-area" style="min-height: 20px; margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>

    <div id="screen-result" class="screen content">
        <h2>Fim de Jogo!</h2>
        
        <div id="result-vs-block" style="display:none;">
            <div class="vs-score-board">
                <div style="text-align: center;">
                    <div id="res-p1-name" style="font-size: 0.8em; color: #555;">P1</div>
                    <div id="res-p1-score" style="font-weight:bold; font-size: 1.5em; color:var(--primary)">0</div>
                    <small id="res-p1-hits">Hits: 0</small>
                </div>
                <div style="align-self:center; font-weight:bold; color: #999;">VS</div>
                <div style="text-align: center;">
                    <div id="res-p2-name" style="font-size: 0.8em; color: #555;">P2</div>
                    <div id="res-p2-score" style="font-weight:bold; font-size: 1.5em; color:var(--vs-color)">0</div>
                    <small id="res-p2-hits">Hits: 0</small>
                </div>
            </div>
            <div id="winner-display" class="winner-highlight"></div>
            <p id="online-waiting-msg" style="display:none; color:gray; font-style:italic;">Aguardando oponente finalizar...</p>
        </div>

        <div id="result-ranked-block" style="display:none;">
            <p>Nick: <strong id="final-nick"></strong></p>
            <p>Pontua√ß√£o Final: <strong id="final-score" style="color: var(--accent); font-size: 2em;"></strong></p>
            <p id="save-status" style="font-style: italic; color: gray;">Salvando no ranking...</p>
            
            <h3 style="margin-top: 30px;">üèÜ Top 10 Global</h3>
            <div id="loading-ranking" class="loader"></div>
            <table id="ranking-table">
                <thead><tr><th>#</th><th>Nick</th><th>Pts</th><th>Data</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <br>
        <button class="btn-main" onclick="location.reload()">Voltar ao Menu</button>
    </div>

</div>

<script type="module">
    // Importa√ß√£o Completa do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, getDocs, query, orderBy, limit, 
        doc, setDoc, updateDoc, getDoc, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB8MomzCsIFp66mFbpvgW3q1CyYMjQWM0k",
        authDomain: "mindspark-32fb7.firebaseapp.com",
        projectId: "mindspark-32fb7",
        storageBucket: "mindspark-32fb7.firebasestorage.app",
        messagingSenderId: "140109681734",
        appId: "1:140109681734:web:6b2bfd08dc37827f172647"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const TABLE_NAME = "ranking_quiz_logica";
    const ROOMS_COLLECTION = "rooms";

    // --------------------------------------------------------------
    // BANCO DE QUEST√ïES
    // --------------------------------------------------------------
    const questionPool = [
        { text: "~p (nega√ß√£o) de uma proposi√ß√£o Falsa √©:", options: ["Falsa", "Verdadeira", "Nula", "Incerta"], correct: 1 },
        { text: "A conjun√ß√£o (p ‚àß q) s√≥ √© verdadeira quando:", options: ["Ambas s√£o verdadeiras", "Ambas s√£o falsas", "Pelo menos uma √© verdadeira", "Pelo menos uma √© falsa"], correct: 0 },
        { text: "A disjun√ß√£o inclusiva (p ‚à® q) √© falsa quando:", options: ["p √© V e q √© F", "p √© F e q √© V", "ambas s√£o F", "ambas s√£o V"], correct: 2 },
        { text: "No condicional (p ‚Üí q), ele s√≥ √© falso quando:", options: ["p √© F e q √© V", "p √© V e q √© F", "ambas s√£o V", "ambas s√£o F"], correct: 1 },
        { text: "O bicondicional (p ‚ÜîÔ∏è q) √© verdadeiro quando:", options: ["As proposi√ß√µes t√™m o mesmo valor", "As proposi√ß√µes s√£o diferentes", "p √© V e q √© F", "p √© F"], correct: 0 },
        { text: "Um silogismo √© v√°lido quando:", options: ["A conclus√£o √© verdadeira", "As premissas s√£o verdadeiras", "A conclus√£o decorre logicamente das premissas", "As premissas s√£o longas"], correct: 2 },
        { text: "Isso √© o que? 'Todo estudante gosta de l√≥gica. Jo√£o gosta de l√≥gica. Logo, Jo√£o √© estudante.'", options: ["Sofisma", "Argumento v√°lido", "Uma frase simples", "Uma tese"], correct: 0 },
        { text: "A dedu√ß√£o l√≥gica consiste em:", options: ["Supor conclus√µes", "Criar conclus√µes prov√°veis", "Aplicar regras formais para conclus√µes necess√°rias", "Opinar sobre premissas"], correct: 2 },
        { text: "No modus ponens, se 'p ‚Üí q' e 'p' s√£o verdadeiros, ent√£o:", options: ["q √© F", "q √© V", "q √© indeterminado", "q contradiz p"], correct: 1 },
        { text: "No modus tollens, se 'p ‚Üí q' √© verdadeiro e 'q' √© F, ent√£o:", options: ["p √© V", "p √© F", "p √© irrelevante", "p √© indeterminado"], correct: 1 },
        { text: "A nega√ß√£o correta de 'p ‚àß q' √©:", options: ["~p ‚àß ~q", "~p ‚à® ~q", "p ‚à® q", "p ‚Üí q"], correct: 1 },
        { text: "A nega√ß√£o correta de 'p ‚Üí q' √©:", options: ["p ‚àß ~q", "~p ‚àß q", "~p ‚àß ~q", "p ‚à® ~q"], correct: 0 },
        { text: "A disjun√ß√£o exclusiva (p ‚äï q) √© verdadeira quando:", options: ["p e q s√£o V", "p e q s√£o F", "apenas uma √© V", "apenas uma √© F"], correct: 2 },
        { text: "Em um silogismo, o termo m√©dio deve:", options: ["Aparecer na conclus√£o", "Ser omitido", "Aparecer nas duas premissas", "Ser sempre o predicado"], correct: 2 },
        { text: "Um sofisma √©:", options: ["Um argumento v√°lido", "Um argumento aparentemente v√°lido, mas falso", "Um silogismo perfeito", "Um racioc√≠nio dedutivo correto"], correct: 1 },
        { text: "A dedu√ß√£o √© incorreta quando:", options: ["Conduz a uma conclus√£o prov√°vel", "As regras formais n√£o s√£o seguidas", "As premissas s√£o verdadeiras", "A conclus√£o est√° escrita de forma errada"], correct: 1 },
        { text: "A tabela-verdade do condicional mostra que ele √© verdadeiro, exceto quando:", options: ["p e q s√£o V", "p √© F", "p √© V e q √© F", "p e q s√£o F"], correct: 2 },
        { text: "Em l√≥gica, uma proposi√ß√£o √©:", options: ["Uma ordem", "Uma pergunta", "Uma frase com valor de verdade", "Uma exclama√ß√£o"], correct: 2 },
        { text: "De 'p ‚Üí q' e 'q ‚Üí r' conclui-se:", options: ["p ‚Üí r", "r ‚Üí p", "p ‚àß r", "q ‚ÜîÔ∏è p"], correct: 0 },
        { text: "O erro em 'Se chover, a rua molha. A rua molhou. Logo, choveu.' √©:", options: ["Modus ponens", "Modus tollens", "Fal√°cia da afirma√ß√£o do consequente", "Silogismo v√°lido"], correct: 2 }
    ];

    // --------------------------------------------------------------
    // ESTADO DO JOGO
    // --------------------------------------------------------------
    let questions = [];
    
    let onlineGameStarted = false; // <--- NOVA TRAVA DE SEGURAN√áA
    let state = { 
        mode: '', // 'ranked', '1v1', 'online'
        index: 0, 
        time: 25, 
        timer: null, 
        busy: false,
        intermissionShown: false, 
        
        // Dados Rankeada
        nick: "", score: 0,
        
        // Dados 1v1 Local e Online
        p1Name: "", p2Name: "",
        p1Score: 0, p2Score: 0,
        p1Hits: 0, p2Hits: 0
    };

    // Vari√°veis Espec√≠ficas do Online
    let currentRoomId = null;
    let myPlayerSlot = ""; // "host" ou "guest"
    let unsubscribeRoom = null;

    // --------------------------------------------------------------
    // NAVEGA√á√ÉO
    // --------------------------------------------------------------
    window.goToRankedSetup = () => {
        document.getElementById('screen-menu').classList.remove('active');
        document.getElementById('screen-setup-ranked').classList.add('active');
    };

    window.goTo1v1Setup = () => {
        document.getElementById('screen-menu').classList.remove('active');
        document.getElementById('screen-setup-1v1').classList.add('active');
    };

    window.goToOnlineSetup = () => {
        document.getElementById('screen-menu').classList.remove('active');
        document.getElementById('screen-setup-online').classList.add('active');
    }

    // --------------------------------------------------------------
    // INICIAR MODOS
    // --------------------------------------------------------------
    
    // --- RANKEADA ---
    window.startRanked = () => {
        const nickInput = document.getElementById('nick-ranked').value.trim();
        if(!nickInput) return alert("Digite um Nickname!");

        state.mode = 'ranked';
        state.nick = nickInput;
        state.score = 0;
        state.index = 0;

        questions = [...questionPool].sort(() => Math.random() - 0.5).slice(0, 10);
        
        setupQuizScreen("var(--primary)", state.nick);
        loadQuestion();
    };

    // --- 1V1 LOCAL ---
    window.start1v1 = () => {
        const p1 = document.getElementById('nick-p1').value.trim() || "Jogador 1";
        const p2 = document.getElementById('nick-p2').value.trim() || "Jogador 2";

        state.mode = '1v1';
        state.p1Name = p1; state.p2Name = p2;
        state.p1Score = 0; state.p2Score = 0;
        state.p1Hits = 0; state.p2Hits = 0;
        state.index = 0;
        state.intermissionShown = false;

        questions = [...questionPool].sort(() => Math.random() - 0.5).slice(0, 10);

        document.getElementById('screen-setup-1v1').classList.remove('active');
        document.getElementById('screen-quiz').classList.add('active');
        updateTurnDisplayLocal();
        loadQuestion();
    };

    // --- 1V1 ONLINE (L√ìGICA) ---
    
    // 1. Criar Sala (Host)
    window.createRoom = async () => {
        const nick = document.getElementById('nick-online').value.trim() || "Host";
        const roomId = Math.floor(1000 + Math.random() * 9000).toString();
        
        currentRoomId = roomId;
        myPlayerSlot = "host";
        state.nick = nick;

        // Gera ordem aleat√≥ria de perguntas
        const shuffledIndices = [...Array(questionPool.length).keys()].sort(() => Math.random() - 0.5).slice(0, 10);

        const roomData = {
            roomId: roomId,
            status: "waiting", 
            host: { name: nick, score: 0, finished: false },
            guest: { name: "", score: 0, finished: false },
            questionOrder: shuffledIndices
        };

        try {
            await setDoc(doc(db, ROOMS_COLLECTION, roomId), roomData);
            document.getElementById('screen-setup-online').classList.remove('active');
            document.getElementById('screen-lobby').classList.add('active');
            document.getElementById('display-room-code').innerText = roomId;
            listenToRoom(roomId);
        } catch(e) {
            alert("Erro ao criar sala: " + e.message);
        }
    };

    // 2. Entrar Sala (Convidado)
    window.joinRoom = async () => {
        const nick = document.getElementById('nick-online').value.trim() || "Convidado";
        const code = document.getElementById('room-code-input').value.trim();

        if(!code) return alert("Digite o c√≥digo!");

        const roomRef = doc(db, ROOMS_COLLECTION, code);
        const roomSnap = await getDoc(roomRef);

        if (!roomSnap.exists()) return alert("Sala n√£o encontrada!");
        if (roomSnap.data().status !== "waiting") return alert("Jogo j√° come√ßou ou sala cheia!");

        currentRoomId = code;
        myPlayerSlot = "guest";
        state.nick = nick;

        await updateDoc(roomRef, {
            "guest.name": nick,
            status: "playing"
        });

        listenToRoom(code);
    };

    // 3. Listener (Sincroniza√ß√£o)
    function listenToRoom(roomId) {
    unsubscribeRoom = onSnapshot(doc(db, ROOMS_COLLECTION, roomId), (docSnapshot) => {
        const data = docSnapshot.data();
        if(!data) return;

        // In√≠cio do Jogo
        if (data.status === "playing" && !onlineGameStarted) {
            onlineGameStarted = true;
            startOnlineGame(data);
        }

        // Atualiza√ß√£o Online
        if (state.mode === 'online') {
            // Atualiza vari√°veis de estado
            state.p1Score = data.host.score;
            state.p2Score = data.guest.score;

            // Se a tela de resultado estiver ativa, atualiza o placar visual
            if(document.getElementById('screen-result').classList.contains('active')){
                showVsResults(data.host.name, data.host.score, "-", data.guest.name, data.guest.score, "-");
                
                // Converte undefined para false (!!) para seguran√ßa
                const hostFinished = !!data.host.finished;
                const guestFinished = !!data.guest.finished;

                // Verifica se AMBOS terminaram para liberar o trof√©u
                if (hostFinished && guestFinished) {
                    document.getElementById('online-waiting-msg').style.display = "none";
                    determineWinner(data.host.score, data.guest.score, data.host.name, data.guest.name);
                }
            }
        }
    });
}

    function startOnlineGame(roomData) {
    // 1. Matar qualquer timer fantasma que possa existir
    clearInterval(state.timer); 
    state.busy = false;

    // 2. Esconde lobby, mostra quiz
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-quiz').classList.add('active');

    state.mode = 'online';
    state.p1Name = roomData.host.name;
    state.p2Name = roomData.guest.name;
    state.p1Score = 0; state.p2Score = 0;
    state.index = 0;
    state.score = 0; 

    // Mapeia os √≠ndices salvos para as perguntas reais
    questions = roomData.questionOrder.map(i => questionPool[i]);

    document.getElementById('quiz-header').style.backgroundColor = "var(--online-color)";
    document.getElementById('player-turn-display').innerText = `Jogando como: ${state.nick}`;
    
    loadQuestion();
}

    // --------------------------------------------------------------
    // AUXILIARES DE TELA
    // --------------------------------------------------------------
    function setupQuizScreen(color, name) {
        document.getElementById('screen-setup-ranked').classList.remove('active');
        document.getElementById('screen-quiz').classList.add('active');
        document.getElementById('player-turn-display').innerText = name;
        document.getElementById('quiz-header').style.backgroundColor = color;
    }

    function updateTurnDisplayLocal() {
        const display = document.getElementById('player-turn-display');
        const header = document.getElementById('quiz-header');
        
        if (state.index < 5) {
            display.innerText = "Vez de: " + state.p1Name;
            header.style.backgroundColor = "var(--accent)";
        } else {
            display.innerText = "Vez de: " + state.p2Name;
            header.style.backgroundColor = "var(--vs-color)";
        }
    }

    window.resumeGame1v1 = () => {
        document.getElementById('screen-intermission').classList.remove('active');
        document.getElementById('screen-quiz').classList.add('active');
        updateTurnDisplayLocal();
        loadQuestion(); 
    }

    // --------------------------------------------------------------
    // L√ìGICA DO QUIZ (CORE)
    // --------------------------------------------------------------

    function loadQuestion() {
        // Pausa para 1v1 Local
        if(state.mode === '1v1' && state.index === 5 && !state.intermissionShown) {
            state.intermissionShown = true;
            document.getElementById('screen-quiz').classList.remove('active');
            document.getElementById('screen-intermission').classList.add('active');
            clearInterval(state.timer);
            return;
        }

        resetTimer();
        const q = questions[state.index];
        document.getElementById('question-text').innerText = q.text;
        
        // Controle de display de progresso
        let displayIndex = state.index + 1;
        let totalQ = 10;
        if(state.mode === '1v1') {
            totalQ = 5;
            if(state.index >= 5) displayIndex -= 5;
        }
        document.getElementById('q-progress').innerText = `Q: ${displayIndex}/${totalQ}`;
        
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        
        q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerText = opt;
            btn.onclick = () => selectAnswer(idx, btn);
            container.appendChild(btn);
        });

        startTimer();
    }

    function selectAnswer(idx, btn) {
        if(state.busy) return;
        state.busy = true;
        clearInterval(state.timer);

        const correct = questions[state.index].correct;
        const feedback = document.getElementById('feedback-area');
        const isCorrect = (idx === correct);

        if(isCorrect) {
            btn.classList.add('correct');
            feedback.innerText = "Correto!";
            feedback.style.color = "#27ae60";
        } else {
            btn.classList.add('wrong');
            const all = document.getElementById('options-container').children;
            all[correct].classList.add('correct');
            feedback.innerText = "Errado!";
            feedback.style.color = "#c0392b";
        }

        // C√°lculo de Pontos
        const points = isCorrect ? (100 + (state.time * 10)) : 0;
        
        if(state.mode === 'ranked') {
            state.score += points;
        } 
        else if (state.mode === '1v1') {
            if(state.index < 5) {
                state.p1Score += points;
                if(isCorrect) state.p1Hits++;
            } else {
                state.p2Score += points;
                if(isCorrect) state.p2Hits++;
            }
        }
        else if (state.mode === 'online') {
            state.score += points; // Acumula no local
            // Envia para o banco
            const updateField = (myPlayerSlot === "host") ? "host.score" : "guest.score";
            const roomRef = doc(db, ROOMS_COLLECTION, currentRoomId);
            updateDoc(roomRef, {
                [updateField]: state.score
            });
        }

        setTimeout(() => {
            state.index++;
            if(state.index < 10) {
                loadQuestion();
            } else {
                finishGame();
            }
        }, 2000);
    }

    function startTimer() {
        state.time = 25;
        const display = document.getElementById('time-display');
        const bar = document.getElementById('timer-bar');
        display.innerText = "25s";
        bar.style.width = "100%";
        state.busy = false;
        document.getElementById('feedback-area').innerText = "";

        state.timer = setInterval(() => {
            state.time--;
            display.innerText = state.time + "s";
            bar.style.width = (state.time / 25 * 100) + "%";
            
            if(state.time <= 0) {
                clearInterval(state.timer);
                timeOut();
            }
        }, 1000);
    }

    function timeOut() {
        state.busy = true;
        const correct = questions[state.index].correct;
        const all = document.getElementById('options-container').children;
        all[correct].classList.add('correct');
        document.getElementById('feedback-area').innerText = "Tempo Esgotado!";
        
        setTimeout(() => {
            state.index++;
            if(state.index < 10) loadQuestion();
            else finishGame();
        }, 2000);
    }

    function resetTimer() { clearInterval(state.timer); }

    // --------------------------------------------------------------
    // FINALIZA√á√ÉO
    // --------------------------------------------------------------

    async function finishGame() {
    // 1. Prepara a tela de resultados
    document.getElementById('screen-quiz').classList.remove('active');
    document.getElementById('screen-result').classList.add('active');
    
    const rankedBlock = document.getElementById('result-ranked-block');
    const vsBlock = document.getElementById('result-vs-block');

    // --- L√≥gica MODOS (Ranked e 1v1 Local continuam iguais) ---
    if(state.mode === 'ranked') {
        rankedBlock.style.display = 'block';
        vsBlock.style.display = 'none';
        document.getElementById('final-nick').innerText = state.nick;
        document.getElementById('final-score').innerText = state.score;
        await saveScore(state.nick, state.score);
    } 
    else if (state.mode === '1v1') {
        rankedBlock.style.display = 'none';
        vsBlock.style.display = 'block';
        showVsResults(state.p1Name, state.p1Score, state.p1Hits, state.p2Name, state.p2Score, state.p2Hits);
        determineWinner(state.p1Score, state.p2Score, state.p1Name, state.p2Name);
    }
    // --- MODO ONLINE (CORRE√á√ÉO AQUI) ---
    else if (state.mode === 'online') {
        rankedBlock.style.display = 'none';
        vsBlock.style.display = 'block';
        
        // Configura√ß√£o inicial visual
        document.getElementById('winner-display').innerText = ""; 
        const waitMsg = document.getElementById('online-waiting-msg');
        waitMsg.style.display = "block";
        waitMsg.innerText = "Aguardando oponente terminar...";
        waitMsg.style.color = "gray";

        // Mostra pontua√ß√£o parcial
        showVsResults(state.p1Name, state.p1Score, "-", state.p2Name, state.p2Score, "-");

        // 1. Avisa o banco que EU terminei
        const roomRef = doc(db, ROOMS_COLLECTION, currentRoomId);
        const fieldToUpdate = (myPlayerSlot === "host") ? "host.finished" : "guest.finished";
        
        await updateDoc(roomRef, {
            [fieldToUpdate]: true
        });

        // 2. CHECK MANUAL: Verifica IMEDIATAMENTE se o outro j√° tinha terminado
        // (Isso resolve o bug de ficar preso esperando algu√©m que j√° acabou)
        const snap = await getDoc(roomRef);
        const data = snap.data();
        
        if (data.host.finished && data.guest.finished) {
            waitMsg.style.display = "none";
            determineWinner(data.host.score, data.guest.score, data.host.name, data.guest.name);
        }
    }
}

    function showVsResults(n1, s1, h1, n2, s2, h2) {
        document.getElementById('res-p1-name').innerText = n1;
        document.getElementById('res-p1-score').innerText = s1;
        document.getElementById('res-p1-hits').innerText = (h1 === "-") ? "" : `${h1}/5 acertos`;

        document.getElementById('res-p2-name').innerText = n2;
        document.getElementById('res-p2-score').innerText = s2;
        document.getElementById('res-p2-hits').innerText = (h2 === "-") ? "" : `${h2}/5 acertos`;
    }

    function determineWinner(s1, s2, n1, n2) {
        const winnerDiv = document.getElementById('winner-display');
        if(s1 > s2) {
            winnerDiv.innerText = `üèÜ ${n1} Venceu!`;
        } else if (s2 > s1) {
            winnerDiv.innerText = `üèÜ ${n2} Venceu!`;
        } else {
            winnerDiv.innerText = `ü§ù Empate!`;
        }
    }

    // --------------------------------------------------------------
    // FIRESTORE RANKING
    // --------------------------------------------------------------
    async function saveScore(nick, score) {
        const statusMsg = document.getElementById('save-status');
        try {
            await addDoc(collection(db, TABLE_NAME), {
                nick: nick, score: score, date: new Date()
            });
            statusMsg.innerText = "Salvo no Ranking Global! üåé";
            statusMsg.style.color = "green";
            loadRanking();
        } catch (e) {
            console.error(e);
            statusMsg.innerText = "Erro ao conectar.";
        }
    }

    async function loadRanking() {
        const loader = document.getElementById('loading-ranking');
        const tbody = document.querySelector('#ranking-table tbody');
        loader.style.display = "block";
        tbody.innerHTML = ""; 

        try {
            const q = query(collection(db, TABLE_NAME), orderBy("score", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            let position = 1;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                let dateStr = "";
                if(data.date && data.date.toDate) dateStr = data.date.toDate().toLocaleDateString('pt-BR');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${position}¬∫</td><td>${data.nick}</td><td><strong>${data.score}</strong></td><td style="font-size:0.8em; color:#666;">${dateStr}</td>`;
                tbody.appendChild(tr);
                position++;
            });
        } catch (e) {
            tbody.innerHTML = "<tr><td colspan='4'>Erro ao carregar ranking.</td></tr>";
        } finally {
            loader.style.display = "none";
        }
    }
</script>

</body>
</html>