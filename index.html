<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindSpark Quiz</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --correct: #27ae60;
            --wrong: #c0392b;
            --light: #ecf0f1;
            --vs-color: #8e44ad;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #ffffff;
            color: #333;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Alinha do topo */
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-top: 50px; /* Espa√ßo para a logo */
            box-sizing: border-box;
        }
        .logo {
            height: 150px;
            width: auto;
            margin-bottom: 2rem;
            object-fit: contain;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 95%;
            max-width: 600px;
            overflow: hidden;
            position: relative;
            min-height: 400px;
        }
        .header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .timer-bar { height: 5px; background-color: var(--accent); width: 100%; transition: width 1s linear; }
        .content { padding: 20px; text-align: center; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .active { display: block; }
        
        input[type="text"] { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px;}
        
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.2s; font-weight: bold; }
        
        .btn-main { background-color: var(--accent); color: white; }
        .btn-main:hover { background-color: #1f6391; }
        
        .btn-vs { background-color: var(--vs-color); color: white; }
        .btn-vs:hover { background-color: #732d91; }

        .btn-option { background-color: var(--light); color: #333; text-align: left; margin-bottom: 8px; font-weight: normal; }
        .btn-option:hover:not([disabled]) { background-color: #dce4e6; transform: translateX(5px); }
        .btn-option.correct { background-color: var(--correct); color: white; }
        .btn-option.wrong { background-color: var(--wrong); color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--accent); color: white; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; display: none; }
        
        .vs-score-board {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            font-size: 1.2em;
        }
        .winner-highlight { color: var(--correct); font-size: 1.5em; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<img class="logo" src="static\logo_mindspark.jpeg" alt="logo mindspark">

<div class="container">
    
    <div id="screen-menu" class="screen active content">
        <h1>‚ö° MindSpark Quiz</h1>
        <p>Escolha seu modo de jogo:</p>
        <button class="btn-main" onclick="window.goToRankedSetup()">üèÜ Jogar Rankeada (Global)</button>
        <button class="btn-vs" onclick="window.goTo1v1Setup()">‚öîÔ∏è 1 vs 1 (Local)</button>
    </div>

    <div id="screen-setup-ranked" class="screen content">
        <h2>üèÜ Modo Rankeada</h2>
        <p>Seu resultado vai para o ranking global!</p>
        <label>Seu Nickname:</label>
        <input type="text" id="nick-ranked" placeholder="Ex: MestreDaLogica" maxlength="15">
        <button class="btn-main" onclick="window.startRanked()">Iniciar Desafio</button>
        <button style="background: #95a5a6; color:white" onclick="location.reload()">Voltar</button>
    </div>

    <div id="screen-setup-1v1" class="screen content">
        <h2>‚öîÔ∏è Modo 1 vs 1</h2>
        <p>Desafie um amigo no mesmo PC/Celular.</p>
        <input type="text" id="nick-p1" placeholder="Nome do Jogador 1" maxlength="10">
        <input type="text" id="nick-p2" placeholder="Nome do Jogador 2" maxlength="10">
        <button class="btn-vs" onclick="window.start1v1()">Come√ßar Batalha</button>
        <button style="background: #95a5a6; color:white" onclick="location.reload()">Voltar</button>
    </div>

    <div id="screen-intermission" class="screen content">
        <h2 style="color: var(--vs-color)">‚úã Pare!</h2>
        <h3>Fim da vez do Jogador 1</h3>
        <p>Passe o dispositivo para o <strong>Jogador 2</strong>.</p>
        <button class="btn-vs" onclick="window.resumeGame1v1()">Sou o Jogador 2, Estou Pronto!</button>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="header" id="quiz-header">
            <span id="player-turn-display">Jogador 1</span>
            <span id="q-progress">Q: 1/10</span>
            <span id="time-display">25s</span>
        </div>
        <div class="timer-bar" id="timer-bar"></div>
        <div class="content">
            <div id="question-text" style="font-size: 1.1em; font-weight: bold; margin-bottom: 20px;">...</div>
            <div id="options-container"></div>
            <div id="feedback-area" style="min-height: 20px; margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>

    <div id="screen-result" class="screen content">
        <h2>Fim de Jogo!</h2>
        
        <div id="result-1v1-block" style="display:none;">
            <div class="vs-score-board">
                <div>
                    <div id="res-p1-name">P1</div>
                    <div id="res-p1-score" style="font-weight:bold; color:var(--accent)">0</div>
                    <small id="res-p1-hits">0 acertos</small>
                </div>
                <div style="align-self:center; font-weight:bold;">VS</div>
                <div>
                    <div id="res-p2-name">P2</div>
                    <div id="res-p2-score" style="font-weight:bold; color:var(--vs-color)">0</div>
                    <small id="res-p2-hits">0 acertos</small>
                </div>
            </div>
            <hr>
            <div id="winner-display" class="winner-highlight"></div>
        </div>

        <div id="result-ranked-block" style="display:none;">
            <p>Nick: <strong id="final-nick"></strong> | Pontos: <strong id="final-score" style="color: var(--accent); font-size: 1.4em;"></strong></p>
            <p id="save-status" style="font-style: italic; color: gray;">Salvando no ranking...</p>
            
            <h3>üèÜ Top 10 Global</h3>
            <div id="loading-ranking" class="loader"></div>
            <table id="ranking-table">
                <thead><tr><th>#</th><th>Nick</th><th>Pts</th><th>Data</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <br>
        <button class="btn-main" onclick="location.reload()">Voltar ao Menu</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB8MomzCsIFp66mFbpvgW3q1CyYMjQWM0k",
        authDomain: "mindspark-32fb7.firebaseapp.com",
        projectId: "mindspark-32fb7",
        storageBucket: "mindspark-32fb7.firebasestorage.app",
        messagingSenderId: "140109681734",
        appId: "1:140109681734:web:6b2bfd08dc37827f172647"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const TABLE_NAME = "ranking_quiz_logica";

    // --------------------------------------------------------------
    // BANCO DE QUEST√ïES
    // --------------------------------------------------------------
    const questionPool = [
        { text: "1. ~p (nega√ß√£o) de uma proposi√ß√£o Falsa √©:", options: ["Falsa", "Verdadeira", "Nula", "Incerta"], correct: 1 },
        { text: "2. Para P^Q (Conjun√ß√£o) ser V, √© preciso:", options: ["P ser V", "Q ser V", "Ambos serem V", "Um deles ser V"], correct: 2 },
        { text: "3. Promessa 'Se P ent√£o Q'. S√≥ √© mentira se:", options: ["P for V e Q for F", "Tudo for F", "Tudo for V", "P for F"], correct: 0 },
        { text: "4. Equivalente a 'Se chove, molha' (Contrapositiva):", options: ["Se molha, chove", "Se n√£o molha, n√£o chove", "N√£o chove e molha", "Molha ou chove"], correct: 1 },
        { text: "5. Modus Tollens: Se A->B e ~B (n√£o B), ent√£o:", options: ["A acontece", "B acontece", "Nada se conclui", "~A (n√£o A)"], correct: 3 },
        { text: "6. Qual N√ÉO √© proposi√ß√£o l√≥gica?", options: ["2+2=5", "O c√©u √© azul", "Feche a porta!", "O gato late"], correct: 2 },
        { text: "7. Disjun√ß√£o (P v Q) s√≥ √© falsa quando:", options: ["P √© F", "Q √© F", "Ambos s√£o F", "Ambos s√£o V"], correct: 2 },
        { text: "8. Argumento que parece certo mas √© erro l√≥gico:", options: ["Silogismo", "Fal√°cia (Sofisma)", "Dedu√ß√£o", "Indu√ß√£o"], correct: 1 },
        { text: "9. Bicondicional (‚Üî) exige:", options: ["Valores iguais", "Valores opostos", "P verdadeiro", "Q falso"], correct: 0 },
        { text: "10. Partir da Regra Geral para o Caso Espec√≠fico:", options: ["Indu√ß√£o", "Dedu√ß√£o", "Abdu√ß√£o", "Intui√ß√£o"], correct: 1 },
        { text: "11. Uma proposi√ß√£o que √© SEMPRE verdadeira chama-se:", options: ["Contradi√ß√£o", "Tautologia", "Conting√™ncia", "Fal√°cia"], correct: 1 },
        { text: "12. A Nega√ß√£o de 'Todo homem √© mortal' √©:", options: ["Nenhum homem √© mortal", "Algum homem n√£o √© mortal", "Algum homem √© mortal", "Todo homem √© imortal"], correct: 1 },
        { text: "13. Leis de Morgan: ~(P ^ Q) equivale a:", options: ["~P ^ ~Q", "~P v ~Q", "P v Q", "~P -> ~Q"], correct: 1 },
        { text: "14. Se A √© Verdadeiro, o que acontece com A v B?", options: ["Sempre Verdadeiro", "Depende de B", "Sempre Falso", "Vira Condicional"], correct: 0 },
        { text: "15. Uma contradi√ß√£o √© uma proposi√ß√£o que √©:", options: ["Sempre Verdadeira", "√Äs vezes Falsa", "Sempre Falsa", "Indeterminada"], correct: 2 },
        { text: "16. O princ√≠pio do 'Terceiro Exclu√≠do' diz que:", options: ["Uma coisa √© ou n√£o √©", "Tudo √© relativo", "Existem 3 op√ß√µes", "A e B podem ser V"], correct: 0 },
        { text: "17. 'P ou n√£o P' (P v ~P) √© exemplo de:", options: ["Contradi√ß√£o", "Tautologia", "Silogismo", "Paradoxo"], correct: 1 },
        { text: "18. O Silogismo √© uma forma de racioc√≠nio:", options: ["Indutivo", "Dedutivo", "Abdutivo", "Intuitivo"], correct: 1 },
        { text: "19. Se P->Q √© verdadeiro e Q √© falso, ent√£o P √©:", options: ["Verdadeiro", "Falso", "Incerto", "Nulo"], correct: 1 },
        { text: "20. 'Algum A √© B' √© uma proposi√ß√£o:", options: ["Universal Afirmativa", "Universal Negativa", "Particular Afirmativa", "Particular Negativa"], correct: 2 }
    ];

    // Vari√°veis de estado
    let questions = [];
    let state = { 
        mode: '', 
        index: 0, 
        time: 25, 
        timer: null, 
        busy: false,
        intermissionShown: false, // <--- NOVA VARI√ÅVEL DE CONTROLE PARA CORRIGIR O BUG
        
        // Dados Rankeada
        nick: "", score: 0,
        
        // Dados 1v1
        p1Name: "", p2Name: "",
        p1Score: 0, p2Score: 0,
        p1Hits: 0, p2Hits: 0
    };

    // --------------------------------------------------------------
    // NAVEGA√á√ÉO
    // --------------------------------------------------------------
    window.goToRankedSetup = () => {
        document.getElementById('screen-menu').classList.remove('active');
        document.getElementById('screen-setup-ranked').classList.add('active');
    };

    window.goTo1v1Setup = () => {
        document.getElementById('screen-menu').classList.remove('active');
        document.getElementById('screen-setup-1v1').classList.add('active');
    };

    // --------------------------------------------------------------
    // INICIAR MODOS
    // --------------------------------------------------------------
    
    window.startRanked = () => {
        const nickInput = document.getElementById('nick-ranked').value.trim();
        if(!nickInput) return alert("Digite um Nickname!");

        state.mode = 'ranked';
        state.nick = nickInput;
        state.score = 0;
        state.index = 0;

        questions = [...questionPool].sort(() => Math.random() - 0.5).slice(0, 10);

        document.getElementById('screen-setup-ranked').classList.remove('active');
        document.getElementById('screen-quiz').classList.add('active');
        
        document.getElementById('player-turn-display').innerText = state.nick;
        document.getElementById('quiz-header').style.backgroundColor = "var(--primary)";
        
        loadQuestion();
    };

    window.start1v1 = () => {
        const p1 = document.getElementById('nick-p1').value.trim() || "Jogador 1";
        const p2 = document.getElementById('nick-p2').value.trim() || "Jogador 2";

        state.mode = '1v1';
        state.p1Name = p1;
        state.p2Name = p2;
        state.p1Score = 0; state.p2Score = 0;
        state.p1Hits = 0; state.p2Hits = 0;
        state.index = 0;
        state.intermissionShown = false; // <--- RESETANDO A VARI√ÅVEL AQUI

        questions = [...questionPool].sort(() => Math.random() - 0.5).slice(0, 10);

        document.getElementById('screen-setup-1v1').classList.remove('active');
        document.getElementById('screen-quiz').classList.add('active');

        updateTurnDisplay();
        loadQuestion();
    };

    function updateTurnDisplay() {
        const display = document.getElementById('player-turn-display');
        const header = document.getElementById('quiz-header');
        
        if (state.index < 5) {
            display.innerText = "Vez de: " + state.p1Name;
            header.style.backgroundColor = "var(--accent)";
        } else {
            display.innerText = "Vez de: " + state.p2Name;
            header.style.backgroundColor = "var(--vs-color)";
        }
    }

    window.resumeGame1v1 = () => {
        document.getElementById('screen-intermission').classList.remove('active');
        document.getElementById('screen-quiz').classList.add('active');
        
        // Aqui n√£o precisamos chamar updateTurnDisplay nem loadQuestion manualmente,
        // vamos deixar o fluxo seguir, mas precisamos garantir que o loop n√£o ocorra.
        updateTurnDisplay();
        loadQuestion(); 
    }

    // --------------------------------------------------------------
    // L√ìGICA DO QUIZ
    // --------------------------------------------------------------

    function loadQuestion() {
        // CORRE√á√ÉO DO BUG AQUI:
        // Verifica se √© hora de pausar E se j√° n√£o pausamos antes
        if(state.mode === '1v1' && state.index === 5 && !state.intermissionShown) {
            
            state.intermissionShown = true; // Marca que j√° pausou
            
            document.getElementById('screen-quiz').classList.remove('active');
            document.getElementById('screen-intermission').classList.add('active');
            
            clearInterval(state.timer); // Garante que o tempo pare
            return; // Para a execu√ß√£o
        }

        resetTimer();
        const q = questions[state.index];
        
        document.getElementById('question-text').innerText = q.text;
        
        let displayIndex = state.index + 1;
        if(state.mode === '1v1' && state.index >= 5) displayIndex -= 5;
        let totalQ = (state.mode === '1v1') ? 5 : 10;

        document.getElementById('q-progress').innerText = `Q: ${displayIndex}/${totalQ}`;
        
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        
        q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerText = opt;
            btn.onclick = () => selectAnswer(idx, btn);
            container.appendChild(btn);
        });

        startTimer();
    }

    function selectAnswer(idx, btn) {
        if(state.busy) return;
        state.busy = true;
        clearInterval(state.timer);

        const correct = questions[state.index].correct;
        const feedback = document.getElementById('feedback-area');
        const isCorrect = (idx === correct);

        if(isCorrect) {
            btn.classList.add('correct');
            feedback.innerText = "Correto!";
            feedback.style.color = "#27ae60";
        } else {
            btn.classList.add('wrong');
            const all = document.getElementById('options-container').children;
            all[correct].classList.add('correct');
            feedback.innerText = "Errado!";
            feedback.style.color = "#c0392b";
        }

        const points = isCorrect ? (100 + (state.time * 10)) : 0;
        
        if(state.mode === 'ranked') {
            state.score += points;
        } else {
            if(state.index < 5) {
                state.p1Score += points;
                if(isCorrect) state.p1Hits++;
            } else {
                state.p2Score += points;
                if(isCorrect) state.p2Hits++;
            }
        }

        setTimeout(() => {
            state.index++;
            if(state.index < 10) {
                loadQuestion();
            } else {
                finishGame();
            }
        }, 2000);
    }

    function startTimer() {
        state.time = 25;
        const display = document.getElementById('time-display');
        const bar = document.getElementById('timer-bar');
        display.innerText = "25s";
        bar.style.width = "100%";
        state.busy = false;
        document.getElementById('feedback-area').innerText = "";

        state.timer = setInterval(() => {
            state.time--;
            display.innerText = state.time + "s";
            bar.style.width = (state.time / 25 * 100) + "%";
            
            if(state.time <= 0) {
                clearInterval(state.timer);
                timeOut();
            }
        }, 1000);
    }

    function timeOut() {
        state.busy = true;
        const correct = questions[state.index].correct;
        const all = document.getElementById('options-container').children;
        all[correct].classList.add('correct');
        document.getElementById('feedback-area').innerText = "Tempo Esgotado!";
        
        setTimeout(() => {
            state.index++;
            if(state.index < 10) loadQuestion();
            else finishGame();
        }, 2000);
    }

    function resetTimer() { clearInterval(state.timer); }

    async function finishGame() {
        document.getElementById('screen-quiz').classList.remove('active');
        document.getElementById('screen-result').classList.add('active');
        
        const rankedBlock = document.getElementById('result-ranked-block');
        const vsBlock = document.getElementById('result-1v1-block');

        if(state.mode === 'ranked') {
            rankedBlock.style.display = 'block';
            vsBlock.style.display = 'none';
            
            document.getElementById('final-nick').innerText = state.nick;
            document.getElementById('final-score').innerText = state.score;
            await saveScore(state.nick, state.score);

        } else {
            rankedBlock.style.display = 'none';
            vsBlock.style.display = 'block';

            document.getElementById('res-p1-name').innerText = state.p1Name;
            document.getElementById('res-p1-score').innerText = state.p1Score;
            document.getElementById('res-p1-hits').innerText = `${state.p1Hits}/5 acertos`;

            document.getElementById('res-p2-name').innerText = state.p2Name;
            document.getElementById('res-p2-score').innerText = state.p2Score;
            document.getElementById('res-p2-hits').innerText = `${state.p2Hits}/5 acertos`;

            const winnerDiv = document.getElementById('winner-display');
            if(state.p1Score > state.p2Score) {
                winnerDiv.innerText = `üèÜ Vencedor: ${state.p1Name}!`;
            } else if (state.p2Score > state.p1Score) {
                winnerDiv.innerText = `üèÜ Vencedor: ${state.p2Name}!`;
            } else {
                winnerDiv.innerText = `ü§ù Empate!`;
            }
        }
    }

    async function saveScore(nick, score) {
        const statusMsg = document.getElementById('save-status');
        try {
            await addDoc(collection(db, TABLE_NAME), {
                nick: nick,
                score: score,
                date: new Date()
            });
            statusMsg.innerText = "Pontua√ß√£o salva no Ranking Global! üåé";
            statusMsg.style.color = "green";
            loadRanking();
        } catch (e) {
            console.error("Erro ao salvar: ", e);
            statusMsg.innerText = "Erro ao conectar (mas voc√™ jogou bem!)";
        }
    }

    async function loadRanking() {
        const loader = document.getElementById('loading-ranking');
        const tbody = document.querySelector('#ranking-table tbody');
        loader.style.display = "block";
        tbody.innerHTML = ""; 

        try {
            const q = query(collection(db, TABLE_NAME), orderBy("score", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            let position = 1;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                let dateStr = "";
                if(data.date && data.date.toDate) {
                    dateStr = data.date.toDate().toLocaleDateString('pt-BR');
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${position}¬∫</td><td>${data.nick}</td><td><strong>${data.score}</strong></td><td style="font-size:0.8em; color:#666;">${dateStr}</td>`;
                tbody.appendChild(tr);
                position++;
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = "<tr><td colspan='4'>Erro ao carregar ranking.</td></tr>";
        } finally {
            loader.style.display = "none";
        }
    }
</script>

</body>
</html>
